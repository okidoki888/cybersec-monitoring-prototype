# Security Guide

## Overview

Этот документ описывает меры безопасности, реализованные в проекте, и рекомендации по безопасной эксплуатации.

## Реализованные меры безопасности

### Аутентификация и Авторизация

1. **JWT Токены**
   - Используется алгоритм HS256
   - Токены истекают через 60 минут
   - JWT_SECRET обязателен и должен быть установлен через переменные окружения

2. **Пароли**
   - Хэшируются с использованием bcrypt
   - Требования к паролям:
     - Минимум 8 символов
     - Минимум 1 заглавная буква
     - Минимум 1 строчная буква
     - Минимум 1 цифра

3. **Роли пользователей**
   - `viewer` - только просмотр
   - `analyst` - управление алертами и правилами
   - `admin` - полный доступ

### Защита от атак

1. **Rate Limiting**
   - Логин endpoint: 5 попыток в минуту
   - Защита от брутфорс атак

2. **SQL Injection**
   - Все запросы параметризованы
   - Используется SQLAlchemy ORM
   - Безопасная обработка фильтров через func.concat()

3. **CORS**
   - Настраивается через ALLOWED_ORIGINS
   - По умолчанию разрешен только localhost:3000

4. **Input Validation**
   - Pydantic валидация всех входных данных
   - Регулярные выражения для username (только буквы, цифры, дефисы)
   - Валидация ролей

### База данных

1. **Foreign Keys**
   - Каскадное удаление (CASCADE) для связанных записей
   - Контроль ссылочной целостности

2. **Индексы**
   - Одиночные индексы на часто используемые поля
   - Составные индексы для сложных запросов
   - Оптимизация производительности

## Конфигурация для Production

### Обязательные переменные окружения

```bash
# Критически важно установить!
JWT_SECRET=<сильный-случайный-секрет-минимум-32-символа>
POSTGRES_PASSWORD=<сильный-пароль-для-БД>
DATABASE_URL=postgresql://user:password@host:port/db

# Рекомендуется
ALLOW_OPEN_SIGNUP=false  # Отключить открытую регистрацию
ALLOWED_ORIGINS=https://yourdomain.com  # Ограничить CORS
```

### Генерация секретов

```bash
# Генерация JWT_SECRET
python -c "import secrets; print(secrets.token_urlsafe(32))"

# Генерация пароля для БД
python -c "import secrets; print(secrets.token_urlsafe(24))"
```

### Рекомендации

1. **Не используйте дефолтные пароли**
   - Измените все пароли из примеров
   - Используйте менеджер паролей

2. **HTTPS**
   - Обязательно используйте HTTPS в production
   - Настройте SSL/TLS сертификаты
   - Используйте reverse proxy (nginx, traefik)

3. **Сетевая безопасность**
   - Ограничьте доступ к БД только для backend
   - Используйте firewall
   - Не открывайте порт БД (5432) наружу

4. **Логирование**
   - Мониторьте failed login attempts
   - Настройте алерты на подозрительную активность
   - Ротация логов

5. **Регулярные обновления**
   - Обновляйте зависимости
   - Мониторьте CVE
   - Используйте dependabot или renovate

## Известные ограничения

1. **Open Signup**
   - Endpoint `/api/auth/signup` доступен если `ALLOW_OPEN_SIGNUP=true`
   - Для production рекомендуется `ALLOW_OPEN_SIGNUP=false`
   - Создавайте пользователей вручную через БД или admin panel

2. **API Key**
   - Опциональная защита для machine-to-machine
   - Если используете, передавайте через X-API-Key header

3. **Rate Limiting**
   - Базовая защита через slowapi
   - Для production рекомендуется использовать nginx rate limiting

## Тестирование безопасности

```bash
# Запуск тестов
cd backend
pytest tests/test_auth.py -v

# Проверка зависимостей на уязвимости
pip install safety
safety check -r requirements.txt
```

## Incident Response

При обнаружении инцидента безопасности:

1. Немедленно ротируйте JWT_SECRET
2. Проверьте логи на подозрительную активность
3. Измените пароли скомпрометированных аккаунтов
4. Обновите все зависимости
5. Сообщите пользователям если необходимо

## Контакты

По вопросам безопасности обращайтесь к администратору проекта.
